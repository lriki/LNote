#! ruby -EWindows-31J
# -*- mode:ruby; coding:Windows-31J -*-
#==============================================================================
# ■ CSSグレースケール化
#==============================================================================


#==============================================================================
# ▲ 設定ここまで
#==============================================================================

def css_grayscale
  
  output_str = ""
  
  css_file = open(ARGV[0])
  
  # 1 行ずつ読んでいく
  while text = css_file.gets do
    # 16進数6桁
    if text =~ /\#[0-9A-Fa-f]{6}/
      mached = $&
      code = mached.delete("#").hex
      
      r = (code >> 16) & 0xff
      g = (code >> 8)  & 0xff
      b = (code)       & 0xff
      
      if r != 255 or g != 255 or b != 255
        y = (0.298912 * r + 0.586611 * g + 0.114478 * b).to_i
        c = y * 65536 + y * 256 + y

        text.gsub!(mached, "#" + c.to_s(16))
      end
    end
    
    output_str += text
  end
  
  open(ARGV[0] + ".gr", "w") {|f| f.write output_str}
end

css_grayscale

#==============================================================================
#
#==============================================================================
